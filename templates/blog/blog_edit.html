{% extends 'blog/base.html' %}

{% block content %}
    <!-- Editor Section -->
    <section class="editor-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="editor-header">
                        <h1><i class="bi bi-pencil-square"></i> {{ entrance }} Blog Post</h1>
                        <p class="text-muted">Write and publish your technical article</p>
                    </div>

                    <form id="blogForm" class="editor-form">
                        {% csrf_token %}
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="blogTitle" class="form-label">
                                <i class="bi bi-type"></i> Title <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="blogTitle"
                                   placeholder="Enter your blog post title..." required>
                        </div>

                        <!-- Category and Tags Row -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="blogCategory" class="form-label">
                                    <i class="bi bi-folder"></i> Category <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="blogCategory" multiple required>
                                    {% for c in category %}
                                    <option value="{{ c.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Add categories to help readers find your content</small>
                            </div>
                            <div class="col-md-4">
                                <label for="blogTags" class="form-label">
                                    <i class="bi bi-tags"></i> Tags <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="blogTags" multiple required>
                                    {% for t in tag %}
                                    <option value="{{ t.id }}">{{ t.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Add tags to help readers find your content</small>
                            </div>
                            <div class="col-md-4">
                                <label for="blogVisible" class="form-label">
                                    <i class="bi bi-tags"></i> Visible <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="blogVisible" required>
                                    {% for v in visible %}
                                    <option value="{{ v.0|add:1 }}">{{ v.1 }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Private blog post will not show to un-authenticated visitor</small>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="mb-4">
                            <label for="blogSummary" class="form-label">
                                <i class="bi bi-text-paragraph"></i> Summary
                            </label>
                            <textarea class="form-control" id="blogSummary" rows="3"
                                      placeholder="Write a brief summary of your article (150-200 characters)..."></textarea>
                            <small class="text-muted">Optional: This will be displayed in the blog list, otherwise display part of content instead of summary</small>
                        </div>

                        <!-- Featured Image -->
                        <div class="mb-4">
                            <label for="featuredImage" class="form-label">
                                <i class="bi bi-image"></i> Featured Image URL
                            </label>
                            <input type="url" class="form-control" id="featuredImage"
                                   placeholder="https://example.com/image.jpg">
                            <small class="text-muted">Optional: Add a cover image for your post, display cover image for blog post later</small>
                        </div>

                        <!-- Rich Text Editor -->
                        <div class="mb-4">
                            <label class="form-label mb-3">
                                <i class="bi bi-file-richtext"></i> Content <span class="text-danger">*</span>
                            </label>
                            <div id="editor" class="editor-container"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                    <i class="bi bi-floppy"></i> Save Draft
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="loadDraft()" id="loadDraftBtn" style="display: none;">
                                    <i class="bi bi-arrow-clockwise"></i> Load Draft
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-danger me-2" onclick="confirmCancel()">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i> {{ entrance }} Post
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Writing Tips -->
                    <div class="writing-tips mt-5">
                        <h5><i class="bi bi-lightbulb"></i> Writing Tips</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="tip-card">
                                    <i class="bi bi-bullseye"></i>
                                    <h6>Be Clear and Concise</h6>
                                    <p>Use simple language and get to the point quickly</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="tip-card">
                                    <i class="bi bi-code-square"></i>
                                    <h6>Include Code Examples</h6>
                                    <p>Show practical examples with well-commented code</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="tip-card">
                                    <i class="bi bi-diagram-3"></i>
                                    <h6>Use Visuals</h6>
                                    <p>Add diagrams, screenshots, and images to illustrate concepts</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Load Draft Confirmation Modal -->
    <div class="modal fade" id="loadDraftModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-clockwise"></i> Load Draft</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This will replace current content with the saved draft. Do you want to continue?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" onclick="confirmLoadDraft()">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Cancel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel?</p>
                    <p class="text-danger mb-0">You have unsaved changes that will be lost.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Stay</button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancelAction()">Yes, Leave</button>
                </div>
            </div>
        </div>
    </div>

    {% load static %}
    <link rel="stylesheet" href="{% static 'vditor/index.css' %}" />
    <script src="{% static 'vditor/index.min.js' %}"></script>
    <script>
        // Initialize Vditor
        let editor;
        const urlPath = window.location.pathname;
        const urlPrefix = window.location.href.split(urlPath)[0];
        editor = new Vditor('editor', {
            height: 600,
            _cdn: "{% static 'vditor' %}",
            mode: 'ir', // preview mode
            placeholder: 'Start writing your article content here... You can use the toolbar above to format text, insert code blocks, add images, and more.',
            theme: 'classic',
            math: { engine: 'KaTeX' },
            counter: { enable: true }, // count words and characters
            preview: {
                hljs: { style: 'github' } // code highlight style
            },
            toolbarConfig: { pin: true },
            // upload configuration
            upload: {
                url: urlPrefix + '/bobjiang/api/vditor/upload/', // backend upload endpoint
                linkToImgUrl: 'api/vditor/upload/',
                filename: name => name.replace(/[^(a-zA-Z0-9\.)]/g, ''),
                format(files, responseText) {
                    //const response = JSON.parse(responseText);
                    //// 检查后端是否成功返回
                    //if (response.code === 0) {
                    //    // 这里可以拿到 succMap 里的所有 URL
                    //    console.log('上传成功，succMap 内容：', response.data.succMap);
                    //    // 如果你想针对第一个上传成功的图片做点什么：
                    //    const firstFileName = Object.keys(response.data.succMap)[0];
                    //    const firstImageUrl = response.data.succMap[firstFileName];
                    //    console.log('获取到的第一个图片 URL:', firstImageUrl);
                    //} else {
                    //    console.error('上传后端报错:', response.msg);
                    //    }

                    // 必须原样返回 responseText（或者符合 Vditor 规范的字符串）这样 Vditor 才会自动在编辑器里插入图片 Markdown
                    // 注意：如果后端返回的 responseText 不是 Vditor 规范的字符串，可能需要在这里进行转换
                    return responseText;
                },
                // only trigger when network request fails (e.g., 404/500), not when backend returns an error code
                error(msg) {
                    console.error('request fail:', msg);
                }
            },
            // toolbar options
            toolbar: [
                'emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|',
                'list', 'ordered-list', 'check', 'outdent', 'indent', '|',
                'quote', 'line', 'code', 'inline-code', 'insert-before', 'insert-after', '|',
                'upload', 'table', 'record', '|',
                'undo', 'redo', '|',
                'fullscreen', 'edit-mode', 'code-theme', 'content-theme', 'export', '|',
                'help'
            ],
            after: () => {
                // 编辑器加载完后的回调
                console.log('Vditor editor initialized successfully');
                {% if entrance == 'Edit' %}
                    // 如果是编辑模式，加载现有内容
                    fetch(urlPrefix + "/bobjiang/api/posts/" + {{post_id}} + "/")
                        .then((response) => response.json())
                        .then((json) => {
                            document.getElementById('blogTitle').value = json['title'];
                            setSelectValues('blogCategory', json['category']);
                            setSelectValues('blogTags', json['tag']);
                            document.getElementById('blogVisible').value = json['visible'];
                            document.getElementById('blogSummary').value = json['summary'] || '';
                            document.getElementById('featuredImage').value = json['img_url'] || '';
                            editor.setValue(editor.html2md(json['content']));
                        })
                        .catch(err=>{
                            console.log(err);
                        });;
                {% endif %}
            }
        });

        // Check if there's a draft on page load
        window.addEventListener('DOMContentLoaded', function() {
            const draft = localStorage.getItem('blogDraft');
            if (draft) {
                document.getElementById('loadDraftBtn').style.display = 'inline-block';
            }
        });

        // Save draft function
        function saveDraft() {
            if (!editor) {
                alert('Editor is not ready yet.');
                return;
            }

            var categorySelect = document.getElementById('blogCategory');
            var selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
            var tagsSelect = document.getElementById('blogTags');
            var selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);

            const draft = {
                title: document.getElementById('blogTitle').value,
                category: selectedCategories,
                tags: selectedTags,
                visible: document.getElementById('blogVisible').value,
                summary: document.getElementById('blogSummary').value,
                featuredImage: document.getElementById('featuredImage').value,
                content: editor.getValue(),
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('blogDraft', JSON.stringify(draft));

            // Show success notification
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Saved!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);

            document.getElementById('loadDraftBtn').style.display = 'inline-block';
        }

        // Load draft function
        function loadDraft() {
            const draftData = localStorage.getItem('blogDraft');
            if (!draftData) {
                alert('No draft found.');
                return;
            }

            // Show confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('loadDraftModal'));
            modal.show();
        }

        // Select element values setting function
        function setSelectValues(elementId, valuesToSelect) {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return;

            // 1. 将输入的数组全部转换为字符串（因为 option.value 永远是字符串）
            const stringValues = valuesToSelect.map(v => String(v));

            // 2. 遍历所有选项并设置选中状态
            Array.from(selectElement.options).forEach(option => {
                // 使用 includes 判断当前 option 是否应该被选中
                option.selected = stringValues.includes(option.value);
            });

            // 3. 【关键】触发 change 事件
            // 某些情况下，UI 不会自动刷新，手动触发一下事件可以通知浏览器更新界面
            const event = new Event('change', { bubbles: true });
            selectElement.dispatchEvent(event);
        }

        // Confirm load draft action
        function confirmLoadDraft() {
            const draftData = localStorage.getItem('blogDraft');
            const draft = JSON.parse(draftData);

            document.getElementById('blogTitle').value = draft.title || '';
            setSelectValues('blogCategory', draft.category);
            setSelectValues('blogTags', draft.tags);
            document.getElementById('blogVisible').value = draft.visible || '';
            document.getElementById('blogSummary').value = draft.summary || '';
            document.getElementById('featuredImage').value = draft.featuredImage || '';
            if (editor && draft.content) {
                editor.setValue(draft.content);
            }

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('loadDraftModal')).hide();

            // Show notification with saved time
            const savedDate = new Date(draft.savedAt);
            const currentTime = new Date();
            showNotification(`Draft loaded successfully! (Saved: ${savedDate.toLocaleString()})`, 'success');
        }

        // Confirm cancel function
        function confirmCancel() {
            const title = document.getElementById('blogTitle').value;
            const content = editor ? editor.getValue() : '';

            // Check if there's any content
            if (title || content.trim().length > 10) {
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
                modal.show();
            } else {
                // No content, just leave
                const urlPath = window.location.pathname;
                const urlPrefix = window.location.href.split(urlPath)[0];
                window.location.href = urlPrefix + '/bobjiang/';
            }
        }

        // Confirm cancel action
        function confirmCancelAction() {
            // Hide modal and navigate
            bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
            const urlPath = window.location.pathname;
            const urlPrefix = window.location.href.split(urlPath)[0];
            window.location.href = urlPrefix + '/bobjiang/';
        }

        // Form submission
        document.getElementById('blogForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!editor) {
                alert('Editor is not initialized yet. Please wait a moment.');
                return;
            }

            var categorySelect = document.getElementById('blogCategory');
            var selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
            var tagsSelect = document.getElementById('blogTags');
            var selectedTags = Array.from(tagsSelect.selectedOptions).map(option => option.value);

            const editData = {
                title: document.getElementById('blogTitle').value,
                category: selectedCategories,
                tags: selectedTags,
                visible: document.getElementById('blogVisible').value,
                summary: document.getElementById('blogSummary').value,
                featuredImage: document.getElementById('featuredImage').value,
                // content: editor.getValue(),  // getValue means get the markdown source text; get the rendered HTML content, use editor.getHTML() instead
                content: editor.getHTML(),
            };

            // Post data to api
            const urlPath = window.location.pathname;
            const urlPrefix = window.location.href.split(urlPath)[0];
            var blogPostUrl = urlPrefix + '/bobjiang/api/posts/';
            {% if entrance == 'Edit' %}
                blogPostUrl += '{{ post_id }}/';
            {% endif %}
            fetch(blogPostUrl,
            {
                {% if entrance == 'Edit' %}
                method: "PUT",
                {% else %}
                method: "POST",
                {% endif %}
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                  title: editData['title'],
                  category: editData['category'],
                  tag: editData['tags'],
                  visible: editData['visible'],
                  summary: editData['summary'],
                  img_url: editData['featuredImage'],
                  content: editData['content']
                }),
              })
                .then((response) => response.json())
                .then((json) => {
                    console.log(json);
                    setTimeout(() => {
                        showNotification('blog post submitted!', 'success');
                    }, 400);

                    // Save and redirect to article
                    window.location.href = urlPrefix + '/bobjiang/article-01' + json['id'] + '/';
                })
                .catch(err=>{
                    console.log(err);
                });;
        });

        // 获取 Cookie 的辅助函数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}